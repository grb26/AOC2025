<!DOCTYPE html>
<html lang="en">
<head>
    <title>AoC Runner</title>
    <style>
        body { font-family: monospace; background: #0f0f23; color: #cccccc; padding: 10px 20px; }
        h1 { color: #00cc00; text-shadow: 0 0 5px #00cc00; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { color: #00cc00; }
        button { background: #00cc00; color: #0f0f23; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; font-family: monospace;}
        .play-btn { background: none; border: none; color: #00cc00; font-size: 20px; padding: 0; cursor: pointer; flex-shrink: 0; }
        .play-btn:hover { color: #ffff66; }
        .day-cell { display: flex; align-items: center; gap: 8px; }
        
        /* Status Indicators */
        .status-idle { color: #666; }
        .status-running { color: #ffff66; }
        .status-success { color: #00cc00; }
        .status-error { color: #ff0000; }

        /* Animation */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hourglass::after { content: "⏳"; display: inline-block; animation: spin 2s linear infinite; }
    </style>
</head>
<body>
    <h1>Advent of Code Runner</h1>
    <button id="runAll">Run All Solutions</button>
    
    <table>
        <thead>
            <tr>
                <th>Day</th>
                <th>Part 1 Tests</th>
                <th>Part 1 Result</th>
                <th>Part 1 Time (ms)</th>
                <th>Part 2 Tests</th>
                <th>Part 2 Result</th>
                <th>Part 2 Time (ms)</th>
                <th>Messages</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const tbody = document.getElementById('tableBody');
        
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('error', (error) => {
            console.error('Socket error:', error);
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        function getRow(day) {
            let row = document.getElementById(`row-${day}`);
            if (!row) {
                row = document.createElement('tr');
                row.id = `row-${day}`;
                row.innerHTML = `
                    <td><div class="day-cell"><button class="play-btn" data-day="${day}">▶</button> Day ${day}</div></td>
                    <td id="test-${day}-1" class="status-idle">-</td>
                    <td id="result-${day}-1" class="status-idle">Waiting...</td>
                    <td id="time-${day}-1">-</td>
                    <td id="test-${day}-2" class="status-idle">-</td>
                    <td id="result-${day}-2" class="status-idle">Waiting...</td>
                    <td id="time-${day}-2">-</td>
                    <td id="messages-${day}" class="status-idle"></td>
                `;
                tbody.appendChild(row);
            }
            return row;
        }

        socket.on('init', (days) => {
            tbody.innerHTML = '';
            days.forEach(day => getRow(day));
        });

        document.getElementById('runAll').onclick = () => {
            // Reset UI
            document.querySelectorAll('[id^=result-]').forEach(el => {
                el.innerText = 'Queued...';
                el.className = 'status-idle';
                el.classList.remove('hourglass');
            });
            document.querySelectorAll('[id^=test-]').forEach(el => {
                el.innerText = '-';
                el.className = 'status-idle';
            });
            document.querySelectorAll('[id^=messages-]').forEach(el => {
                el.innerText = '';
                el.className = 'status-idle';
            });
            socket.emit('run-all');
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('play-btn')) {
                const day = parseInt(e.target.dataset.day);
                //console.log('Running day:', day);
                // Reset UI for this day
                document.getElementById(`result-${day}-1`).innerText = 'Queued...';
                document.getElementById(`result-${day}-1`).className = 'status-idle';
                document.getElementById(`test-${day}-1`).innerText = '-';
                document.getElementById(`test-${day}-1`).className = 'status-idle';
                document.getElementById(`result-${day}-2`).innerText = 'Queued...';
                document.getElementById(`result-${day}-2`).className = 'status-idle';
                document.getElementById(`test-${day}-2`).innerText = '-';
                document.getElementById(`test-${day}-2`).className = 'status-idle';
                document.getElementById(`messages-${day}`).innerText = '';
                document.getElementById(`messages-${day}`).className = 'status-idle';
                //console.log('Emitting run-day:', day);
                socket.emit('run-day', day);
            }
        });

        socket.on('worker-update', (data) => {
            const { day, type, part } = data;
            const testCell = document.getElementById(`test-${day}-${part}`);
            const resultCell = document.getElementById(`result-${day}-${part}`);
            const timeCell = document.getElementById(`time-${day}-${part}`);
            const messagesCell = document.getElementById(`messages-${day}`);

            if (type === 'test-start') {
                testCell.innerText = 'Running...';
                testCell.className = 'status-running';
            }
            if (type === 'test-result') {
                if (data.success) {
                    if (testCell.innerText === 'Running...') {
                        testCell.innerText = '';
                    }
                    testCell.innerText += '✅';
                    if (testCell.className != 'status-error') {
                        testCell.className = 'status-success';
                    }
                } else {
                    if (testCell.innerText === 'Running...') {
                        testCell.innerText = '';
                    }
                    testCell.innerText += '❌';
                    testCell.className = 'status-error';
                    const errorMsg = `Part ${part} Test ${data.index + 1}: Expected ${data.expected}, got ${data.actual}`;
                    messagesCell.innerText += (messagesCell.innerText ? '\n' : '') + errorMsg;
                    messagesCell.className = 'status-error';
                }
            }
            if (type === 'solve-start') {
                resultCell.innerText = '';
                resultCell.className = 'hourglass'; // Starts animation
            }
            if (type === 'solve-done') {
                resultCell.classList.remove('hourglass');
                resultCell.innerText = data.result;
                resultCell.className = 'status-success';
                timeCell.innerText = data.durationMs;
            }
            if (type === 'error') {
                resultCell.classList.remove('hourglass');
                resultCell.innerText = data.error;
                resultCell.className = 'status-error';
                messagesCell.innerText += (messagesCell.innerText ? '\n' : '') + data.error;
                messagesCell.className = 'status-error';
            }
        });
    </script>
</body>
</html>